{% extends 'proyectos/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

<link rel="stylesheet" href="{% static 'css/gantt.css' %}">
<script src="{% static 'js/gantt_logic.js' %}"></script>

<div class="container-fluid mt-4">
    
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body py-3">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-md-3">
                    <h4 class="mb-0 text-dark fw-bold"><i class="bi bi-kanban me-2 text-primary"></i>Cronograma</h4>
                </div>
                
                <div class="col-md-3">
                    <select name="proyecto" class="form-select form-select-sm bg-light border-0" onchange="this.form.submit()">
                        <option value="">ðŸ“‚ Todos los proyectos</option>
                        {% for p in proyectos %}
                        <option value="{{ p.id }}" {% if filtros.proyecto|add:"0" == p.id %}selected{% endif %}>
                            {{ p.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <select name="recurso" class="form-select form-select-sm bg-light border-0" onchange="this.form.submit()">
                        <option value="">ðŸ‘· Todo el personal</option>
                        {% for r in recursos %}
                        <option value="{{ r.id }}" {% if filtros.recurso|add:"0" == r.id %}selected{% endif %}>
                            {{ r.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3 text-end">
                    <div class="btn-group btn-group-sm btn-group-vista" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="cambiarVista('Day', this)">DÃ­a</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="cambiarVista('Week', this)">Semana</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="cambiarVista('Month', this)">Mes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="gantt-target"></div>
    
    {% if not gantt_data|length > 0 %} 
    <div class="text-center mt-5 py-5 text-muted">
        <i class="bi bi-clipboard-x display-4 opacity-50"></i>
        <p class="mt-3">No hay tareas para mostrar con los filtros seleccionados.</p>
    </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Pasamos los datos de Django al mundo JavaScript de forma limpia
        const tareasBackend = {{ gantt_data|safe }};
        
        // URL de la API generada por Django
        // AsegÃºrate de tener esta ruta nombrada en tu urls.py
        const urlApi = "{% url 'actualizar_tarea_api' %}"; 
        
        // Llamamos a la funciÃ³n que creamos en gantt_logic.js
        iniciarGantt(tareasBackend, urlApi);
    });
</script>

{% endblock %}